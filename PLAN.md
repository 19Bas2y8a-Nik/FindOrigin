# План реализации Telegram-бота FindOrigin

## Этап 1: Настройка проекта и окружения

1.1. Инициализация Next.js проекта
- Создать Next.js проект с TypeScript
- Настроить структуру папок (app/api для API routes)
- Установить необходимые зависимости

1.2. Настройка переменных окружения
- Создать `.env.local` файл
- Добавить переменные:
  - `TELEGRAM_BOT_TOKEN` - токен бота от BotFather
  - `TELEGRAM_WEBHOOK_SECRET` (опционально, для безопасности)
  - `AI_API_KEY` - ключ для AI API (OpenAI/Anthropic/etc.)

1.3. Настройка TypeScript и линтеров
- Проверить конфигурацию TypeScript
- Настроить ESLint/Prettier (если нужно)

---

## Этап 2: Базовая структура Telegram бота

2.1. Создание типов для Telegram API
- Определить интерфейсы для `Update`, `Message`, `Chat`
- Типы для входящих webhook запросов

2.2. Создание базового webhook endpoint
- Создать API route: `app/api/telegram/webhook/route.ts`
- Реализовать POST обработчик
- Добавить базовую валидацию входящих данных
- Вернуть 200 OK быстро (без долгих операций)

2.3. Обработка базовых команд
- Извлечение `chat.id` и `text` из `update.message`
- Реализовать команду `/start` для приветствия
- Реализовать команду `/help` с инструкциями

---

## Этап 3: Интеграция с Telegram API

3.1. Создание утилиты для отправки сообщений
- Функция `sendMessage(chatId, text)` 
- Использование Telegram Bot API
- Обработка ошибок API

3.2. Обработка различных типов сообщений
- Текстовые сообщения
- Сообщения со ссылками
- Пересланные сообщения

---

## Этап 4: Извлечение текста из Telegram постов

4.1. Парсинг ссылок на Telegram посты
- Определение формата ссылок (t.me/channel/123)
- Функция для извлечения channel/username и message_id
- Использование Telegram API для получения поста по ссылке

4.2. Извлечение текста из поста
- Получение полного текста сообщения
- Обработка форматирования (Markdown/HTML)
- Очистка текста от лишних символов

---

## Этап 5: Анализ и извлечение ключевой информации

5.1. Извлечение ключевых утверждений
- Использование NLP/AI для выделения основных тезисов
- Определение фактологических утверждений

5.2. Извлечение структурированных данных
- Даты (регулярные выражения + AI для контекста)
- Числа и статистика
- Имена собственные (персоны, организации, места)
- Ссылки (если есть в тексте)

5.3. Создание структуры данных для анализа
- Интерфейс для хранения извлеченной информации
- Приоритизация ключевых элементов

---

## Этап 6: Поиск источников информации

6.1. Выбор стратегии поиска
- Определение типов источников: официальные сайты, новостные, блоги, исследования
- Приоритизация источников по типу информации

6.2. Интеграция с поисковыми API
- Google Search API / SerpAPI / Bing Search API
- Построение поисковых запросов на основе извлеченной информации
- Обработка результатов поиска

6.3. Фильтрация и ранжирование результатов
- Определение релевантности источников
- Фильтрация по доменам (официальные, новостные и т.д.)
- Ограничение количества результатов (топ 5-10 для дальнейшего анализа)

---

## Этап 7: AI-сравнение и оценка источников

7.1. Интеграция с AI API
- Выбор провайдера (OpenAI GPT, Anthropic Claude, etc.)
- Настройка промптов для сравнения

7.2. Реализация сравнения смысла
- Создание промпта для AI:
  - Исходный текст/утверждение
  - Кандидаты на источники
  - Задача: сравнить смысл, не буквальный текст
- Обработка ответа AI

7.3. Оценка уверенности
- Получение от AI оценки релевантности каждого источника
- Нормализация оценок (0-100% или 0-1)
- Ранжирование по уверенности

7.4. Фильтрация результатов
- Выбор топ 1-3 источников с наивысшей уверенностью
- Минимальный порог уверенности (например, >50%)

---

## Этап 8: Форматирование и отправка ответа

8.1. Форматирование результатов
- Структурирование ответа:
  - Краткое описание найденных источников
  - Список ссылок (1-3)
  - Оценка уверенности для каждого
- Использование Markdown для форматирования

8.2. Отправка ответа пользователю
- Использование функции `sendMessage`
- Обработка длинных сообщений (разбиение при необходимости)
- Обработка ошибок отправки

---

## Этап 9: Асинхронная обработка (оптимизация)

9.1. Реализация фоновой обработки
- Webhook возвращает 200 OK сразу
- Запуск асинхронной обработки (queue/background job)
- Использование Vercel Edge Functions или внешнего сервиса

9.2. Уведомление пользователя о процессе
- Отправка "Обрабатываю..." сразу
- Обновление сообщения после завершения

9.3. Обработка таймаутов
- Установка максимального времени обработки
- Graceful degradation при ошибках

---

## Этап 10: Обработка ошибок и edge cases

10.1. Валидация входных данных
- Проверка формата ссылок
- Обработка пустых/некорректных сообщений
- Валидация токенов и секретов

10.2. Обработка ошибок API
- Telegram API ошибки
- AI API ошибки
- Поисковые API ошибки
- Retry логика для временных ошибок

10.3. Логирование
- Настройка системы логирования
- Логирование ошибок и важных событий
- Мониторинг производительности

---

## Этап 11: Тестирование

11.1. Unit тесты
- Тесты для функций извлечения данных
- Тесты для парсинга ссылок
- Тесты для форматирования

11.2. Integration тесты
- Тесты webhook endpoint
- Тесты интеграции с Telegram API
- Тесты AI сравнения

11.3. Ручное тестирование
- Тестирование различных типов сообщений
- Тестирование различных типов источников
- Проверка производительности

---

## Этап 12: Деплой на Vercel

12.1. Подготовка к деплою
- Настройка `vercel.json` (если нужно)
- Проверка переменных окружения
- Оптимизация bundle size

12.2. Настройка Telegram Webhook
- Получение публичного URL от Vercel
- Установка webhook через Telegram API
- Проверка работы webhook

12.3. Мониторинг после деплоя
- Проверка логов Vercel
- Мониторинг ошибок
- Проверка производительности

---

## Этап 13: Документация и финализация

13.1. Документация кода
- Комментарии к основным функциям
- README с инструкциями по запуску
- Описание архитектуры

13.2. Пользовательская документация
- Обновление `/help` команды
- Примеры использования
- FAQ по возможным проблемам

---

## Приоритизация этапов

**MVP (Минимально жизнеспособный продукт):**
- Этапы 1-4, 7 (базовая версия), 8, 12

**Полная версия:**
- Все этапы 1-13

**Оптимизация:**
- Этап 9 (асинхронная обработка) можно добавить после MVP
